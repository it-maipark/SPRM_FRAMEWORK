@{
    ViewBag.Title = "Grid";
}

<style>
    .btn-mark-as-complete {
        width: 22px;
        height: 22px;
        border: 1px solid #aaa;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background-color: white;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
    }

    .btn-mark-as-complete:hover {
        border-color: #0056b3;
        background-color: #e6f0ff;
    }

    .btn-mark-as-complete .check-icon {
        font-size: 0.7rem;
        color: #0056b3;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .btn-mark-as-complete.selected .check-icon {
        opacity: 1;
    }

    .ap-cell {
        position: relative;
        text-align: center;
        vertical-align: middle;
    }

    .action-buttons {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        gap: 8px;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.85);
        padding: 6px 8px;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.1);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .ap-cell:hover .action-buttons {
        display: flex;
        opacity: 1;
        pointer-events: auto;
    }

    label.error {
        display: block;
        margin-top: 5px;
        color: #e74c3c;
        font-size: 0.85rem;
        white-space: normal;
        word-break: break-word;
    }
</style>

<div class="page-inner">
    <div class="page-header">
        <h4 class="page-title">Grid</h4>
        <ul class="breadcrumbs">
            <li class="nav-home">
                <a href="#">
                    <i class="flaticon-home"></i>
                </a>
            </li>
            <li class="separator">
                <i class="flaticon-right-arrow"></i>
            </li>
            <li class="nav-item">
                <a href="#">Plan Manager</a>
            </li>
            <li class="separator">
                <i class="flaticon-right-arrow"></i>
            </li>
            <li class="nav-item">
                <a href="#">Grid</a>
            </li>
        </ul>
    </div>
    <!-- Inner Page -->
    <div class="card">
        <div class="card-body">
            <ul class="nav nav-pills nav-primary nav-pills-no-bd nav-pills-icons" id="pills-tab-with-icon" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pills-active-tab-icon" data-toggle="pill" href="#pills-active-icon" role="tab" aria-controls="pills-active-icon" aria-selected="true">
                        Active
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-complete-tab-icon" data-toggle="pill" href="#pills-complete-icon" role="tab" aria-controls="pills-complete-icon" aria-selected="false">
                        Complete
                    </a>
                </li>
            </ul>
            <div class="tab-content mt-2 mb-3" id="pills-with-icon-tabContent">
                <div class="tab-pane fade show active" id="pills-active-icon" role="tabpanel" aria-labelledby="pills-active-tab-icon">
                    <table id="apTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Codification</th>
                                <th>Assignment</th>
                                <th>Start date</th>
                                <th>Due date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center h3 font-weight-bold">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="pills-complete-icon" role="tabpanel" aria-labelledby="pills-complete-tab-icon">
                    <table id="apTableComplete" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Codification</th>
                                <th>Assignment</th>
                                <th>Start date</th>
                                <th>Due date</th>
                                <th>Completed date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center h3 font-weight-bold">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Assignment Modal -->
<div class="modal fade" id="addAssignmentModal" aria-labelledby="addAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <form id="addAssignmentValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="addAssignmentModalLabel">Assignment</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="ap-id" name="ap-id" placeholder="Input ap-id here..." hidden>
                    <div class="form-group form-show-validation row">
                        <label for="select-assignment" class="col-4 mt-sm-2 text-left">Assignment <span class="required-label">*</span></label>
                        <div class="col-8">
                            <div class="select2-input">
                                <select id="select-assignment" name="select-assignment[]" class="form-control" multiple="multiple">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Start Date Modal -->
<div class="modal fade" id="addStartDateModal" aria-labelledby="addStartDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form id="addStartDateValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="addStartDateModalLabel">Add Start Date</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="add-sd-ap-id" name="add-sd-ap-id" hidden />
                    <input type="text" class="form-control" id="add-sd-ap-timeline" name="add-sd-ap-timeline" hidden />
                    <div class="form-group form-show-validation row">
                        <label for="start-date" class="col-4 mt-sm-2 text-left">Start Date <span class="required-label">*</span></label>
                        <div class="col-8" style="min-height: 65px;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="start-date" name="start-date" placeholder="Select date here..." required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-calendar-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Due Date Modal -->
<div class="modal fade" id="addDueDateModal" aria-labelledby="addDueDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form id="addDueDateValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="addDueDateModalLabel">Add Due Date</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="add-dd-ap-id" name="add-dd-ap-id" hidden />
                    <input type="text" class="form-control" id="add-dd-ap-timeline" name="add-dd-ap-timeline" hidden />
                    <input type="text" class="form-control" id="add-dd-ap-start-date" name="add-dd-ap-start-date" hidden />
                    <div class="form-group form-show-validation row">
                        <label for="due-date" class="col-4 mt-sm-2 text-left">Due Date <span class="required-label">*</span></label>
                        <div class="col-8" style="min-height: 65px;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="due-date" name="due-date" placeholder="Select date here..." required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-calendar-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Assignment Modal -->
<div class="modal fade" id="editAssignmentModal" aria-labelledby="editAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <form id="editAssignmentValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="editAssignmentModalLabel">Assignment</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="edit-ap-id" name="edit-ap-id" placeholder="Input ap-id here..." hidden>
                    <div class="form-group form-show-validation row">
                        <label for="edit-select-assignment" class="col-4 mt-sm-2 text-left">Assignment <span class="required-label">*</span></label>
                        <div class="col-8">
                            <div class="select2-input">
                                <select id="edit-select-assignment" name="edit-select-assignment[]" class="form-control" multiple="multiple">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Start Date Modal -->
<div class="modal fade" id="editStartDateModal" aria-labelledby="editStartDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form id="editStartDateValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="editStartDateModalLabel">Edit Start Date</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="edit-sd-ap-id" name="edit-sd-ap-id" hidden />
                    <input type="text" class="form-control" id="edit-sd-ap-timeline" name="edit-sd-ap-timeline" hidden />
                    <input type="text" class="form-control" id="edit-sd-ap-due-date" name="edit-sd-ap-due-date" hidden />
                    <div class="form-group form-show-validation row">
                        <label for="edit-start-date" class="col-4 mt-sm-2 text-left">Start Date <span class="required-label">*</span></label>
                        <div class="col-8" style="min-height: 65px;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="edit-start-date" name="edit-start-date" placeholder="Select date here..." required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-calendar-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Due Date Modal -->
<div class="modal fade" id="editDueDateModal" aria-labelledby="editDueDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form id="editDueDateValidation" enctype="multipart/form-data">
                <div class="modal-header">
                    <h2 class="modal-title font-weight-bold" id="editDueDateModalLabel">Edit Due Date</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="number" class="form-control" id="edit-dd-ap-id" name="edit-dd-ap-id" hidden />
                    <input type="text" class="form-control" id="edit-dd-ap-timeline" name="edit-dd-ap-timeline" hidden />
                    <input type="text" class="form-control" id="edit-dd-ap-start-date" name="edit-dd-ap-start-date" hidden />
                    <div class="form-group form-show-validation row">
                        <label for="edit-due-date" class="col-4 mt-sm-2 text-left">Due Date <span class="required-label">*</span></label>
                        <div class="col-8" style="min-height: 65px;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="edit-due-date" name="edit-due-date" placeholder="Select date here..." required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-calendar-o"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var token = localStorage.getItem("AccessToken");
        var userMaipark = localStorage.getItem("Username");
        var userRole = localStorage.getItem("UserRole");
        var employeeData = localStorage.getItem("employeeData");

        if (userRole) {
            var roleObj = JSON.parse(userRole);
            var roleName = roleObj.roleName;
        }

        if (employeeData) {
            var employeeDataObj = JSON.parse(employeeData);
        }

        $(document).ready(function () {
            $('#navLink-3').addClass('nav-item active');

            // Inisialisasi datetimepicker
            $('#start-date, #due-date, #edit-start-date, #edit-due-date').datetimepicker({
                format: 'DD/MM/YYYY'
            });
            
            // rule validation
            // start date rule
            $.validator.addMethod("dateWithinTimeline", function(value, element, params) {
                const timeline = $(params).val(); // format: "MM/YYYY - MM/YYYY"
                const [startStr, endStr] = timeline.split(" - ");

                const inputDate = moment(value, 'DD/MM/YYYY');
                const timelineStart = moment("01/" + startStr, 'DD/MM/YYYY');
                const timelineEnd = moment("01/" + endStr, 'DD/MM/YYYY').endOf('month');

                const isValid = inputDate.isBetween(timelineStart, timelineEnd, undefined, '[]');

                if (!isValid) {
                    const errorMsg = `Date must be within the timeline range, Timeline: ${timeline}`;
                    element.setAttribute("data-error-msg", errorMsg);
                }

                return isValid;
            }, function (_, element) {
                return $(element).data("error-msg") || "Date must be within the timeline range.";
            });

            // due date rule
            $.validator.addMethod("validDueDate", function (value, element, param) {
                const start = moment($(param).val(), "DD/MM/YYYY"); // param langsung adalah selector
                const due = moment(value, "DD/MM/YYYY");

                if (!start.isValid() || !due.isValid()) return false;

                const isValid = due.isSameOrAfter(start);

                if (!isValid) {
                    const errorMsg = `Due date must be the same or after start date. Start Date: ${start.format("DD/MM/YYYY")}`;
                    element.setAttribute("data-error-msg", errorMsg);
                }

                return isValid;
            }, function (_, element) {
                return $(element).data("error-msg") || "Due date must be the same or after start date.";
            });

            // start date rule
            $.validator.addMethod("validStartDate", function (value, element, param) {
                const due = moment($(param).val(), "DD/MM/YYYY"); // param langsung adalah selector
                const start = moment(value, "DD/MM/YYYY");

                if (!start.isValid() || !due.isValid()) return false;

                const isValid = start.isSameOrBefore(due);

                if (!isValid) {
                    const errorMsg = `Start date must be the same or before due date. Due Date: ${due.format("DD/MM/YYYY")}`;
                    element.setAttribute("data-error-msg", errorMsg);
                }

                return isValid;
            }, function (_, element) {
                return $(element).data("error-msg") || "Start date must be the same or before due date.";
            });

            // handle validation add assignment
            $("#addAssignmentValidation").validate({
                validClass: "success",
                rules: {
                    "select-assignment[]": {
                        required: true,
                    },
                },
                messages: {
                    "select-assignment[]": {
                        required: "Please Select Assignment.",
                    },
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());
                    var assignmentValues = $('#select-assignment').val();

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['ap-id'],
                      assignment: assignmentValues,
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Added successfully!',
                                text: 'New assignment has been added.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to assign the action plan."
                            }).then(() => {
                                console.error('Unable to assign the action plan', error);
                            });
                        }
                    });
                }
            });

            // handle validation add start date
            $("#addStartDateValidation").validate({
                validClass: "success",
                rules: {
                    "start-date": {
                        required: true,
                        dateWithinTimeline: "#add-sd-ap-timeline",
                    },
                },
                messages: {
                    "start-date": {
                        required: "Please input Start Date.",
                    },
                },
                errorPlacement: function (error, element) {
                    error.addClass("mt-1"); // kasih jarak atas
                    error.insertAfter(element.closest('.input-group')); // taruh setelah input group
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['add-sd-ap-id'],
                      startDate: moment.utc(rawData['start-date'], 'DD/MM/YYYY').toISOString(),
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Added successfully!',
                                text: 'New start date has been added.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to add the start date."
                            }).then(() => {
                                console.error('Unable to add the start date', error);
                            });
                        }
                    });
                }
            });

            // handle validation add due date
            $("#addDueDateValidation").validate({
                validClass: "success",
                rules: {
                    "due-date": {
                        required: true,
                        dateWithinTimeline: "#add-dd-ap-timeline",
                        validDueDate: "#add-dd-ap-start-date",
                    },
                },
                messages: {
                    "due-date": {
                        required: "Please input Due Date.",
                    },
                },
                errorPlacement: function (error, element) {
                    error.addClass("mt-1"); // kasih jarak atas
                    error.insertAfter(element.closest('.input-group')); // taruh setelah input group
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['add-dd-ap-id'],
                      dueDate: moment.utc(rawData['due-date'], 'DD/MM/YYYY').toISOString(),
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Added successfully!',
                                text: 'New due date has been added.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to add the due date."
                            }).then(() => {
                                console.error('Unable to add the due date', error);
                            });
                        }
                    });
                }
            });

            // handle validation edit assignment
            $("#editAssignmentValidation").validate({
                validClass: "success",
                rules: {
                    "edit-select-assignment[]": {
                        required: true,
                    },
                },
                messages: {
                    "edit-select-assignment[]": {
                        required: "Please Select Assignment.",
                    },
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());
                    var assignmentValues = $('#edit-select-assignment').val();

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['edit-ap-id'],
                      assignment: assignmentValues,
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Update successfully!',
                                text: 'The assignment has been updated.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to update the action plan."
                            }).then(() => {
                                console.error('Unable to assign the action plan', error);
                            });
                        }
                    });
                }
            });

            // handle validation edit start date
            $("#editStartDateValidation").validate({
                validClass: "success",
                rules: {
                    "edit-start-date": {
                        required: true,
                        dateWithinTimeline: "#edit-sd-ap-timeline",
                        validStartDate: "#edit-sd-ap-due-date",
                    },
                },
                messages: {
                    "edit-start-date": {
                        required: "Please input Start Date.",
                    },
                },
                errorPlacement: function (error, element) {
                    error.addClass("mt-1"); // kasih jarak atas
                    error.insertAfter(element.closest('.input-group')); // taruh setelah input group
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['edit-sd-ap-id'],
                      startDate: moment.utc(rawData['edit-start-date'], 'DD/MM/YYYY').toISOString(),
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Update successfully!',
                                text: 'The start date has been updated.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to update the start date."
                            }).then(() => {
                                console.error('Unable to update the start date', error);
                            });
                        }
                    });
                }
            });

            // handle validation edit due date
            $("#editDueDateValidation").validate({
                validClass: "success",
                rules: {
                    "edit-due-date": {
                        required: true,
                        dateWithinTimeline: "#edit-dd-ap-timeline",
                        validDueDate: "#edit-dd-ap-start-date",
                    },
                },
                messages: {
                    "edit-due-date": {
                        required: "Please input Due Date.",
                    },
                },
                errorPlacement: function (error, element) {
                    error.addClass("mt-1"); // kasih jarak atas
                    error.insertAfter(element.closest('.input-group')); // taruh setelah input group
                },
                submitHandler: function (form) {
                    var formData = new FormData(form);
                    var rawData = Object.fromEntries(formData.entries());

                    // Mapping ke camelCase
                    var jsonData = {
                      id: rawData['edit-dd-ap-id'],
                      dueDate: moment.utc(rawData['edit-due-date'], 'DD/MM/YYYY').toISOString(),
                      lastUpdatedBy: userMaipark
                    };

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/PlanManager/UpdateActionPlan'),
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: JSON.stringify(jsonData),
                        success: function (response) {
                            // Show SweetAlert2 success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Update successfully!',
                                text: 'The Due date has been updated.',
                            }).then(() => {
                                // Refresh the user management page or perform any other actions
                                location.reload();
                            });
                        },
                        error: function (error) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong. Unable to update the due date."
                            }).then(() => {
                                console.error('Unable to update the due date', error);
                            });
                        }
                    });
                }
            });

            // Generate datatable grid
            $.ajax({
              url: apiUrl('/PlanManager/GetGrid'),
              method: 'GET',
              dataType: 'json',
              headers: { 'Authorization': 'Bearer ' + token },
              success: function(response) {
                // Enrich data: tambahkan canEdit ke setiap item
                const dataPromises = response.data.map(item => {
                  return $.ajax({
                    url: apiUrl('/Lookup/GetEmployeeByUserMaipark'),
                    method: 'GET',
                    data: { username: item.createdBy },
                    headers: { 'Authorization': 'Bearer ' + token }
                  }).then(res => {
                    return { ...item, canEdit: ((res.data.divId === employeeDataObj.divId && roleName == 'Dept Head') || (res.data.divId === employeeDataObj.divId && roleName == "Group Head") || roleName == 'Administrator') };
                  }).catch(() => {
                    return { ...item, canEdit: false };
                  });
                });

                Promise.all(dataPromises).then(enrichedData => {
                  $('#apTable').DataTable({
                    destroy: true,
                    data: enrichedData,
                    columns: [
                      {
                        data: null,
                        orderable: false,
                        searchable: false,
                        defaultContent: '',
                        className: 'text-center',
                        render: function (data, type, row) {
                          if (row.canEdit) {
                            return `
                              <div
                                class="btn-mark-as-complete"
                                data-id="${row.id}"
                                data-title="${row.title}"
                                data-toggle="tooltip"
                                title="Mark Complete"
                              >
                                <i class="fas fa-check check-icon"></i>
                              </div>
                            `;
                          }
                          return '';
                        }
                      },
                      { data: 'title' },
                      { data: 'codification' },
                      {
                        data: 'assignment',
                        render: function(data, type, row) {
                          if ((!data || data.length === 0) && row.canEdit) {
                            return `
                              <button 
                                class="btn btn-sm btn-outline-primary btn-add-assignment" 
                                data-toggle="modal" 
                                data-placement="bottom"
                                data-id="${row.id}"
                                data-lead-group="${row.leadGroup}"
                                data-support-group="${row.supportGroup}"
                                data-toggle="modal"
                                data-target="#addAssignmentModal"
                                title="Add Assignment"
                              >
                                <i class="fas fa-plus"></i>
                              </button>
                            `;
                          }
                          return (data || []).map(username => `
                            <div class="d-flex align-items-center mb-1">
                              <div class="rounded-circle bg-primary text-white d-inline-flex justify-content-center align-items-center"
                                   style="width:28px;height:28px;font-size:0.75rem;">
                                ${username[0].toUpperCase()}
                              </div>
                              <span class="ml-2">${username}</span>
                            </div>
                            ${(row.canEdit)
                                ? `
                                    <div class="action-buttons">
                                      <button
                                        class="btn btn-sm btn-outline-primary btn-edit-assignment"
                                        data-toggle="modal"
                                        data-id="${row.id}"
                                        data-lead-group="${row.leadGroup}"
                                        data-support-group="${row.supportGroup}"
                                        data-assignment="${row.assignment}"
                                        data-target="#editAssignmentModal"
                                        data-placement="top"
                                        title="Edit Assignment"
                                      >
                                        <i class="fa fa-edit"></i>
                                      </button>
                                    </div>
                                  `
                                : ''}
                          `).join('');
                        },
                        createdCell: function(td, cellData, rowData, row, col) {
                          $(td).addClass('ap-cell');
                        }
                      },
                      {
                        data: 'startDate',
                        render: function(data, type, row) {
                          if (!data && row.canEdit) {
                            return `
                              <button 
                                class="btn btn-sm btn-outline-primary btn-add-start-date" 
                                data-id="${row.id}"
                                data-timeline="${row.timeline}"
                                data-toggle="modal"
                                data-target="#addStartDateModal"
                                title="Add Start date"
                              >
                                <i class="fas fa-plus"></i>
                              </button>
                            `;
                          }
                          if (data && row.canEdit) {
                              return data 
                                        ?
                                          `
                                            ${moment(data).format('DD/MM/YYYY')}
                                            <div class="action-buttons">
                                              <button
                                                class="btn btn-sm btn-outline-primary btn-edit-start-date"
                                                data-toggle="modal"
                                                data-id="${row.id}"
                                                data-timeline="${row.timeline}"
                                                data-start-date="${row.startDate}"
                                                data-target="#editStartDateModal"
                                                data-placement="top"
                                                title="Edit StartDate"
                                              >
                                                <i class="fa fa-edit"></i>
                                              </button>
                                            </div>
                                          `
                                        : '';
                          }
                          return data ? moment(data).format('DD/MM/YYYY') : '';
                        },
                        createdCell: function(td, cellData, rowData, row, col) {
                          $(td).addClass('ap-cell');
                        }
                      },
                      {
                        data: 'dueDate',
                        render: function(data, type, row) {
                          if (!data && row.canEdit && row.startDate) {
                            return `
                              <button 
                                class="btn btn-sm btn-outline-primary btn-add-due-date" 
                                data-id="${row.id}"
                                data-start-date="${row.startDate}"
                                data-timeline="${row.timeline}"
                                data-toggle="modal"
                                data-target="#addDueDateModal"
                                title="Add Due date">
                                <i class="fas fa-plus"></i>
                              </button>
                            `;
                          }

                          const due = moment(data).startOf('day');
                          const today = moment().startOf('day');
                          const daysDiff = due.diff(today, 'days'); // tidak perlu pakai true

                          let badgeClass = 'badge-secondary';
                          if (daysDiff < 0) {
                            badgeClass = 'badge-danger';    // lewat deadline
                          } else if (daysDiff <= 5) {
                            badgeClass = 'badge-warning';   // dekat deadline
                          } else if (daysDiff <= 14) {
                            badgeClass = 'badge-success';   // masih aman
                          }

                          if (data && row.canEdit) {
                            return data 
                                      ? `
                                          <span class="badge ${badgeClass}">${due.format('DD/MM/YYYY')}</span>
                                          <div class="action-buttons">
                                            <button
                                              class="btn btn-sm btn-outline-primary btn-edit-due-date"
                                              data-toggle="modal"
                                              data-id="${row.id}"
                                              data-start-date="${row.startDate}"
                                              data-timeline="${row.timeline}"
                                              data-due-date="${row.dueDate}"
                                              data-target="#editDueDateModal"
                                              data-placement="top"
                                              title="Edit DueDate"
                                            >
                                              <i class="fa fa-edit"></i>
                                            </button>
                                          </div>
                                        ` 
                                      : '';
                          }
                          return data ? `<span class="badge ${badgeClass}">${due.format('DD/MM/YYYY')}</span>` : ''
                        },
                        createdCell: function(td, cellData, rowData, row, col) {
                          $(td).addClass('ap-cell');
                        }
                      }
                    ],
                    drawCallback: function() {
                      $('[data-toggle="tooltip"]').tooltip();
                    }
                  });
                });
              },
              error: function(xhr, status, error) {
                console.error('Gagal mengambil data:', error);
              }
            });

            // Generate datatable grid complete
            $.ajax({
              url: apiUrl('/PlanManager/GetGridComplete'),
              method: 'GET',
              dataType: 'json',
              headers: { 'Authorization': 'Bearer ' + token },
              success: function(response) {
                    $('#apTableComplete').DataTable({
                      destroy: true,
                      data: response.data,
                      responsive: true,
                      autoWidth: false,
                      columns: [
                        { data: 'title' },
                        { data: 'codification' },
                        {
                          data: 'assignment',
                          render: function(data, type, row) {
                            return (data || []).map(username => `
                              <div class="d-flex align-items-center mb-1">
                                <div class="rounded-circle bg-primary text-white d-inline-flex justify-content-center align-items-center"
                                     style="width:28px;height:28px;font-size:0.75rem;">
                                  ${username[0].toUpperCase()}
                                </div>
                                <span class="ml-2">${username}</span>
                              </div>
                            `).join('');
                          }
                        },
                        {
                          data: 'startDate',
                          render: function(data, type, row) {
                            return data ? moment(data).format('DD/MM/YYYY') : '';
                          }
                        },
                        {
                          data: 'dueDate',
                          render: function(data, type, row) {
                            return data ? moment(data).format('DD/MM/YYYY') : ''
                          }
                        },
                        {
                          data: 'completedAt',
                          render: function(data, type, row) {
                            return data ? moment(data).format('DD/MM/YYYY') : '';
                          }
                        }
                      ],
                      drawCallback: function() {
                        $('[data-toggle="tooltip"]').tooltip();
                      }
                    });
                  },
                  error: function(xhr, status, error) {
                    console.error('Gagal mengambil data:', error);
                  }
            });

            // event delegation
            $('#apTable')
                .on('click', '.btn-add-assignment', e => {
                    const btn = e.currentTarget.dataset;
                    $('#ap-id').val(btn.id);
                    let actionPlanGroup = '';
                    if (btn.supportGroup == 'All Group') {
                        actionPlanGroup = btn.supportGroup;
                    } else {
                        actionPlanGroup = btn.leadGroup + ', ' + btn.supportGroup;
                    }

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/Lookup/GetEmployeeByDivisions'),
                        type: 'GET',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: { divisions: actionPlanGroup },
                        success: function (response) {
                            // Initials Assignment
                            $('#select-assignment').empty();
                            $('#select-assignment').append('<option value="">Select Assignment..</option>');

                            // Feeding Data
                            $.each(response.data, function (index, item) {
                                $('#select-assignment').append('<option value="' + item.userMaipark + '"> ' + item.name + '</option>');
                            });

                            // Inisialisasi select2 Assignment setelah opsi ditambahkan
                            $('#select-assignment').select2({
                                theme: "bootstrap",
                                width: '100%',
                                placeholder: "Select Assignment...",
                            });
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                })
                .on('click', '.btn-add-start-date', e => {
                    const btn = e.currentTarget.dataset;
                    $('#add-sd-ap-id').val(btn.id);
                    $('#add-sd-ap-timeline').val(btn.timeline);
                })
                .on('click', '.btn-add-due-date', e => {
                    const btn = e.currentTarget.dataset;
                    const startDate = moment(btn.startDate).format("DD/MM/YYYY")
                    $('#add-dd-ap-id').val(btn.id);
                    $('#add-dd-ap-timeline').val(btn.timeline);
                    $('#add-dd-ap-start-date').val(startDate)
                })
                .on('click', '.btn-mark-as-complete', e => {
                    $(this).toggleClass('selected');
                    const btn = e.currentTarget.dataset;
                    const apId = btn.id,
                          apTitle = btn.title;

                    // Menampilkan sweet alert konfirmasi
                    Swal.fire({
                        title: "Are you sure?",
                        text: "You want to Mark Complete this Action Plan? (" + apTitle + ")",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, Mark Complete!"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: apiUrl('/PlanManager/UpdateActionPlanMarkAsCompleted?id=' + apId + '&completedBy=' + userMaipark),
                                type: 'PUT',
                                xhrFields: { withCredentials: true },
                                headers: { 'Authorization': 'Bearer ' + token },
                                success: function (response) {
                                    Swal.fire({
                                        title: "Update successful!",
                                        text: "The action plan has been updated to mark as completed.",
                                        icon: "success"
                                    }).then(() => {
                                        location.reload();
                                    });
                                },
                                error: function (error) {
                                    // Tampilkan sweet alert jika terjadi kesalahan
                                    Swal.fire({
                                        icon: "error",
                                        title: "Oops...",
                                        text: "Something went wrong. Unable to update the action plan."
                                    }).then(() => {
                                        console.error('Update action plan failed', error);
                                    });
                                }
                            });
                        }
                    });
                })
                .on('click', '.btn-edit-assignment', e => {
                    const btn = e.currentTarget.dataset;
                    $('#edit-ap-id').val(btn.id);
                    let actionPlanGroup = '';
                    if (btn.supportGroup == 'All Group') {
                        actionPlanGroup = btn.supportGroup;
                    } else {
                        actionPlanGroup = btn.leadGroup + ', ' + btn.supportGroup;
                    }

                    // Mengirim data menggunakan Ajax
                    $.ajax({
                        url: apiUrl('/Lookup/GetEmployeeByDivisions'),
                        type: 'GET',
                        contentType: 'application/json',
                        headers: { 'Authorization': 'Bearer ' + token },
                        data: { divisions: actionPlanGroup },
                        success: function (response) {
                            // Initials Assignment
                            $('#edit-select-assignment').empty();
                            $('#edit-select-assignment').append('<option value="">Select Assignment..</option>');

                            // Feeding Data
                            $.each(response.data, function (index, item) {
                                $('#edit-select-assignment').append('<option value="' + item.userMaipark + '"> ' + item.name + '</option>');
                            });

                            // Data Assignment
                            const assignment = btn.assignment.split(',').map(s => s.trim());

                            // Tambahkan ke select2 jika belum ada opsinya
                            assignment.forEach(group => {
                                if ($("#edit-select-assignment option[value='" + group + "']").length === 0) {
                                    $('#edit-select-assignment').append(`<option value="${group}">${e}</option>`);
                                }
                            });

                            // Set value dan trigger change agar select2 nge-render ulang
                            $('#edit-select-assignment').val(assignment).trigger('change');

                            // Inisialisasi select2 Assignment setelah opsi ditambahkan
                            $('#edit-select-assignment').select2({
                                theme: "bootstrap",
                                width: '100%',
                                placeholder: "Select Assignment...",
                            });
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                })
                .on('click', '.btn-edit-start-date', e => {
                    const btn = e.currentTarget.dataset;
                    const dueDate = moment(btn.dueDate).format("DD/MM/YYYY")
                    $('#edit-sd-ap-id').val(btn.id);
                    $('#edit-sd-ap-timeline').val(btn.timeline);
                    $('#edit-sd-ap-due-date').val(dueDate);
                    $('#edit-start-date').datetimepicker('date', moment(btn.startDate));
                })
                .on('click', '.btn-edit-due-date', e => {
                    const btn = e.currentTarget.dataset;
                    const startDate = moment(btn.startDate).format("DD/MM/YYYY")
                    $('#edit-dd-ap-id').val(btn.id);
                    $('#edit-dd-ap-timeline').val(btn.timeline);
                    $('#edit-dd-ap-start-date').val(startDate);
                    $('#edit-due-date').datetimepicker('date', moment(btn.dueDate));
                })
        });
    </script>
}